!function(t){t.fn._vs.aggregate={defaultSettings:{},strata_layers:function(t,a,e,n){function r(t,a){return{x:a,y:Math.max(0,t)}}{var s=d3.scale.linear().domain([1,e-2]).range([Math.PI/2,2*Math.PI-Math.PI/2]);d3.scale.pow().exponent(10).domain([0,e]).range([0,1])}return d3.range(a).map(function(a){var i=5*Math.random();return d3.range(e).map(function(e){if("sin"==t.settings.sedimentation.aggregation.strataType){if(1==a)return 20;var r=5+5*i*Math.sin(s(e))+50*a;return 0>r?-r:r}return"log"==t.settings.sedimentation.aggregation.strataType?a+1:("undefined"==typeof n&&(n=0),t.settings.data.strata[n][a].value)}).map(r)})},init:function(t){if("undefined"!=typeof t.settings.data.strata&&0!=t.settings.data.strata.length&&0!=t.settings.data.strata[0].length){var a=t.token.colorRange;if("StackedAreaChart"==t.settings.chart.type){var e=t.settings.chart.width/t.settings.data.model.length,n=t.settings.sedimentation.aggregation.height,r=d3.select("#"+t.settings.DOMelement.id).append("div").attr("class","vis").style("z-index",10).append("svg").attr("width",t.settings.width).attr("height",t.settings.height).append("g").attr("transform","translate("+t.settings.chart.x+","+t.settings.chart.y+")"),s=r.selectAll("g.gcol").data(t.settings.data.strata,function(t){return[t]}).enter().append("g").attr("transform",function(a,n){return"translate("+n*e+", "+(t.settings.chart.height-t.settings.sedimentation.aggregation.height)+")"}).attr("class",function(t,a){return"gcol col_"+a}),i=t.settings.data.strata.map(function(t){return{value:t[0].value}}),g=(t.settings.data.strata[0].length,20);smx=g-1,smy=0;var c=0,d=d3.svg.area().x(function(a){return t.settings.chart.spacer+a.x*(e-2*t.settings.chart.spacer)/smx}).y0(function(t){return n-t.y0*c}).y1(function(t){return n-(t.y+t.y0)*c}),o=s.selectAll("gpath").data(function(a,e){var n=d3.layout.stack().offset("expand")(t.aggregate.strata_layers(t,a.length,g,e));return smy=d3.max(n,function(t){return d3.max(t,function(t){return t.y0+t.y})}),n.map(function(t){t.map(function(t){return t.col=e,t})}),n}).enter().append("g").attr("class","gpath");o.append("path").attr("d",function(a){return c=t.settings.chart.height-t.chart.getPosition(t)[a[0].col].y,d(a)}).style("fill",function(e,n){return null!=t.settings.data.strata[e[0].col][n].texture?"url(#RectanglePattern_"+e[0].col+"_"+n+")":d3.rgb(a(e[0].col)).darker(t.settings.data.strata[e[0].col].length/2-(n+1)/2)}).attr("class",function(){return"layer"}).attr("class",function(t,a){return"col_"+t[0].col+" layer_"+a});for(var u=e/1,l=u,h=0;h<t.settings.data.strata.length;h++)for(var f=0;f<t.settings.data.strata[h].length;f++)if(null!=t.settings.data.strata[h][f].texture){var p=r.append("pattern").attr("id","RectanglePattern_"+h+"_"+f).attr("height",l).attr("width",u).attr("patternTransform","translate(0, 0) scale("+t.settings.data.strata[h][f].texture.size+", "+t.settings.data.strata[h][f].texture.size+") rotate(0)").attr("patternUnits","userSpaceOnUse");p.append("image").attr("x",0).attr("y",0).attr("height",l).attr("width",u).attr("xlink:href",function(){return t.settings.data.strata[h][f].texture.url})}}else if("CircleLayout"==t.settings.chart.type){var m=d3.select("#"+t.settings.DOMelement.id).append("div").attr("class","vis").attr("width",t.settings.width).attr("height",t.settings.height).append("svg").attr("width",t.settings.width).attr("height",t.settings.height);if("undefined"!=typeof t.settings.chart.treeLayout)for(var y=0;y<t.settings.data.model.length;y++){var i=t.settings.data.strata[y],a=function(){return t.token.colorRange(y)};t.aggregate.create_pie_chart(t,i,m,i[0].value,a,(y+.5)*t.settings.chart.width/t.settings.data.model.length+t.settings.chart.x,t.settings.chart.y+t.settings.chart.height/6)}else{var i=t.settings.data.strata.map(function(t){return{value:t[0].value}});console.log(t.settings.data.strata,i);var a=t.token.colorRange;t.aggregate.create_pie_chart(t,i,m,t.settings.chart.radius,a,t.settings.chart.x+t.settings.chart.width/2,t.settings.chart.y+t.settings.chart.height/2)}}}},create_pie_chart:function(t,a,e,n,r,s,i){{var g=t.settings.width/t.settings.data.model.length,c=t.settings.sedimentation.aggregation.height;d3.scale.linear().domain([0,t.settings.data.strata.length-1]).range([0,t.settings.width]),d3.scale.linear().domain([0,d3.max(a,function(t){return t.value})]).rangeRound([0,c]),t.settings.width,t.settings.height,t.settings.sedimentation.aggregation.height}labelr=n+30,donut=d3.layout.pie().sort(null),arc=d3.svg.arc().innerRadius(0).outerRadius(n);var d=Math.random();e.append("g.arcs_"+d).attr("class","arcs_"+d);{var o=e.selectAll(".arcs").data(donut(a.map(function(t){return t.value}))).enter().append("svg:g").attr("transform","translate("+s+","+i+")"),u=0;d3.svg.area().x(function(a){return t.settings.chart.spacer+a.x*(g-2*t.settings.chart.spacer)/smx}).y0(function(t){return c-t.y0*u}).y1(function(t){return c-(t.y+t.y0)*u}),o.append("path").attr("fill",function(t,a){return r(a)}).attr("d",function(t){return arc(t)}).each(function(t){this._current=t})}},update:function(t){if("undefined"!=typeof t.settings.data.strata&&0!=t.settings.data.strata.length&&0!=t.settings.data.strata[0].length){var a=t.settings.chart.width/t.settings.data.model.length,e=t.settings.sedimentation.aggregation.height,n=(d3.scale.linear().domain([0,t.settings.data.strata.length-1]).range([0,t.settings.width]),t.settings.data.strata.map(function(t){return{value:t[0].value}}),t.settings.data.strata.map(function(t){for(var a=0,e=0;a<t.length;a++)e+=t[a].value;return e})),r=d3.scale.linear().domain([0,d3.max(n)]).range([0,t.settings.sedimentation.aggregation.height]),s=(t.settings.data.strata[0].length,20);smx=s-1,smy=0;var i=0,g=d3.svg.area().x(function(e){return t.settings.chart.spacer+e.x*(a-2*t.settings.chart.spacer)/smx}).y0(function(t){return e-t.y0*i}).y1(function(t){return e-(t.y+t.y0)*i}),c=d3.select("svg"),d=c.selectAll(".gcol");d.data(t.settings.data.strata,function(t){return[t]});var o=d.selectAll(".gpath").data(function(a,e){var n=d3.layout.stack().offset("expand")(t.aggregate.strata_layers(t,a.length,s,e));return smy=d3.max(n,function(t){return d3.max(t,function(t){return t.y0+t.y})}),n.map(function(t){t.map(function(t){return t.col=e,t})}),n});o.select("path").transition().duration(100).attr("d",function(a,s){return t.chartUpdate(s,-r(n[s])-(e-t.settings.chart.height)),i=t.settings.chart.height-t.chart.getPosition(t)[a[0].col].y,g(a)})}}}}(jQuery);