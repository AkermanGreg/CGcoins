!function($){$.fn._vs.strata={stratas:[],init:function(_this){function fstrata(){for(var t=Array(),a=0;a<mySettings.data.model.length;a++)t.push(fstratum(a));return t}function fstratum(t){for(var a=Array(NB_STRATA),e=0;e<a.length;e++)a[e]=Array();if("undefined"!=typeof _this)for(var n=_this.selectAll("category",s).attr("state").filter(function(t){return 2==t?t:void 0}).length,r=0;r<n.length;r++)for(var i=n[r],e=0;e<a.length;e++)i<_this.settings.stream.now-2*e&&i>=_this.settings.stream.now-2*(e+1)&&a[a.length-e-1].push(i);for(var g=Array(),o=0;NB_STRATA>o;o++){var l=a[o].length;!function(a){g.push({value:function(){return a},label:"Strata "+o,category:t})}(l)}return g}if("StackedAreaChart"!=_this.settings.chart.type)return void _this.strata.create_strata(_this);if(settings=_this.settings,"function"!=typeof settings.data.strata&&("undefined"==typeof settings.data.strata||0==settings.data.strata.length)){for(var i=0;i<settings.data.model.length;i++){var defaultStrata={label:settings.data.model[i].label+"_"+i,category:i,value:function(){return 0}};_this.strata.stratas[i]=[defaultStrata]}return void _this.strata.create_strata(_this)}if("function"!=typeof settings.data.strata){if("undefined"!=typeof settings.data.strata[0]&&"undefined"!=typeof settings.data.strata[0][0].value){for(var NB_STRATA=settings.data.strata[0].length,i=0;i<settings.data.model.length;i++){_this.strata.stratas[i]=[];for(var n=0;NB_STRATA>n;n++)!function(a,b){var t=null;"undefined"!=typeof settings.data.strata[a]&&"undefined"!=typeof settings.data.strata[a][b]&&"undefined"!=typeof settings.data.strata[a][b].texture&&(t=settings.data.strata[a][b].texture);var defaultStrata={};defaultStrata={label:settings.data.model[i].label+"_"+a,category:a,texture:t,value:function(){return(r=eval("f="+settings.data.strata[a][b].value))()}},_this.strata.stratas[a].push(defaultStrata)}(i,n)}return void _this.strata.create_strata(_this)}if("undefined"!=typeof settings.data.strata[0]&&"undefined"!=typeof settings.data.strata[0][0]){for(var c=0;c<settings.data.model.length;c++){var defaultStrata={label:settings.data.model[c].label+"_"+c,category:i,value:function(t,a){return t.selectAll("category",a)?settings.data.strata[a][0].initValue+t.selectAll("category",a).attr("state").filter(function(t){return 2==t?t:void 0}).length:settings.data.strata[a][0].initValue}};_this.strata.stratas[c]=[defaultStrata]}return void _this.strata.create_strata(_this)}if(0==settings.data.strata[0].length){for(var i=0;i<settings.data.model.length;i++){var defaultStrata={label:settings.data.model[i].label+"_"+i,category:i,value:function(t,a){return t.selectAll("category",a)?t.selectAll("category",a).attr("state").filter(function(t){return 2==t?t:void 0}).length:0}};_this.strata.stratas[i]=[defaultStrata]}return void _this.strata.create_strata(_this)}var NB_STRATA=settings.data.strata[0].length;return settings.data.strata_param=settings.data.strata,_this.settings.data.strata=function(){return fstrata()},_this.strata.stratas=_this.settings.data.strata(),void _this.strata.create_strata(_this)}if("function"==typeof settings.data.strata||settings.data.strata[0].length>0||_this.strata.stratas.length>0){if("function"==typeof settings.data.strata||settings.data.strata[0].length>0&&"object"==typeof settings.data.strata[0])if("function"==typeof settings.data.strata)_this.strata.stratas=settings.data.strata();else if("function"==typeof settings.data.strata[0].value)for(var i=0;i<settings.data.model.length;i++){var defaultStrata={label:settings.data.model[i].label+"_"+i,category:i,initValue:settings.data.model[i].value,value:function(){return settings.data.strata[i]}};_this.strata.stratas[i]=[defaultStrata]}else for(var i=0;i<settings.data.model.length;i++){var defaultStrata={label:settings.data.model[i].label+"_"+i,category:i,initValue:settings.data.model[i].value,value:function(t,a){return"undefined"==typeof t.selectAll("category",a).length?this.initValue:t.selectAll("category",a)?this.initValue+t.selectAll("category",a).attr("state").filter(function(t){return 2==t?t:void 0}).length:0}};_this.strata.stratas[i]=[defaultStrata]}_this.strata.create_strata(_this)}},selectAll:function(t,a,e){if(result=[],result.attr=function(t,a,e){var s=[];return result.forEach(function(n){q=n.attr(t,a,e),s.push(q)}),s},"undefined"==typeof e&&"undefined"==typeof a)return this.stratas;for(var s=t.strata.stratas.length-1;s>=0;s--)if(t.strata.stratas[s].attr(a)==e){result.push(t.strata.stratas[s]);break}return"undefined"==typeof result[0]?!1:result[0]},add:function(t,a){var e=function(){};return e.myobj=a,e.attr=function(t,a,e){return"undefined"==typeof a?"undefined"!=typeof this[t]?this[t]():this.myobj[t]:("undefined"!=typeof this[t]?this[t](a,e):this.myobj[t]=a,this)},e},remove:function(){},strata_layers:function(t,a,e,s){function n(t,a){return{x:a,y:Math.max(0,t)}}{var r=d3.scale.linear().domain([1,e-2]).range([Math.PI/2,2*Math.PI-Math.PI/2]);d3.scale.pow().exponent(10).domain([0,e]).range([0,1])}return d3.range(a).map(function(a){var i=5*Math.random();return d3.range(e).map(function(e){if("sin"==t.settings.sedimentation.aggregation.strataType){if(1==a)return 20;var n=5+5*i*Math.sin(r(e))+50*a;return 0>n?-n:n}return"log"==t.settings.sedimentation.aggregation.strataType?a+1:("undefined"==typeof s&&(s=0),t.strata.stratas[s][a].value(t,s))}).map(n)})},create_strata:function(t){if("StackedAreaChart"==t.settings.chart.type){var a=t.settings.chart.width/t.settings.data.model.length,e=t.settings.sedimentation.aggregation.height,s=t.token.colorRange;if("undefined"!=typeof t.settings.options.canvasFirst&&0==t.settings.options.canvasFirst)var n=d3.select("#"+t.settings.DOMelement.id).insert("div",":first-child").style("position","absolute").attr("class","vis").style("z-index",10).append("svg").attr("width",t.settings.width).attr("height",t.settings.height).append("g").attr("transform","translate("+t.settings.chart.x+","+t.settings.chart.y+")");else var n=d3.select("#"+t.settings.DOMelement.id).append("div").attr("class","vis").style("z-index",10).append("svg").attr("width",t.settings.width).attr("height",t.settings.height).append("g").attr("transform","translate("+t.settings.chart.x+","+t.settings.chart.y+")");var r=(t.strata.stratas[0].length,20);smx=r-1,smy=0;var i=t.strata.stratas.map(function(a,e){for(var s=0,n=0;s<a.length;s++)n+=a[s].value(t,e);return n}),g=d3.scale.linear().domain([0,Math.max(d3.max(i),t.settings.sedimentation.aggregation.maxData)]).range([0,t.settings.sedimentation.aggregation.height]),o=n.selectAll("g.gcol").data(t.strata.stratas,function(t){return[t]}).enter().append("g").attr("transform",function(e,s){var n=t.settings.sedimentation.aggregation.height;return t.settings.sedimentation.aggregation.invertStrata&&(n=2*t.settings.sedimentation.aggregation.height-g(i[s])),"translate("+s*a+", "+(t.settings.chart.height-n)+")"}).attr("class",function(t,a){return"gcol col_"+a}),l=o.selectAll(".gpath").data(function(a,e){var s=d3.layout.stack().offset("expand")(t.strata.strata_layers(t,a.length,r,e));return smy=d3.max(s,function(t){return d3.max(t,function(t){return t.y0+t.y})}),s.map(function(t){t.map(function(t){return t.col=e,t})}),s}).enter().append("g").attr("class","gpath"),d=d3.svg.area().x(function(e){return t.settings.chart.spacer+e.x*(a-2*t.settings.chart.spacer)/smx}).y0(function(t){return e-t.y0*t.offshit}).y1(function(t){return e-(t.y+t.y0)*t.offshit}),u=l.append("path").attr("d",function(a,s){return t.chartUpdate(s,-g(i[s])-(e-t.settings.chart.height)),hh=0,a.map(function(t){return t.offshit=hh,t}),d(a)});u.style("fill",function(a,e){return null!=t.strata.stratas[a[0].col][e].texture?"url(#RectanglePattern_"+a[0].col+"_"+e+")":d3.rgb(s(a[0].col)).darker(t.strata.stratas[a[0].col].length/2-(e+1)/2)}).attr("class",function(t,a){return"gcol col_"+t[0].col+" layer_"+a});var h=a/1,c=h;if("undefined"!=typeof t.settings.data.strata)for(var f=0;f<t.settings.data.strata.length;f++)for(var p=0;p<t.settings.data.strata[f].length;p++)if(null!=t.settings.data.strata[f][p].texture){var v=n.append("pattern").attr("id","RectanglePattern_"+f+"_"+p).attr("height",c).attr("width",h).attr("patternTransform","translate(0, 0) scale("+t.settings.data.strata[f][p].texture.size+", "+t.settings.data.strata[f][p].texture.size+") rotate(0)").attr("patternUnits","userSpaceOnUse");v.append("image").attr("x",0).attr("y",0).attr("height",c).attr("width",h).attr("xlink:href",function(){return t.settings.data.strata[f][p].texture.url})}}else if("CircleLayout"==t.settings.chart.type){var y=d3.select("#"+t.settings.DOMelement.id).append("div").attr("class","vis").attr("width",t.settings.width).attr("height",t.settings.height).append("svg").attr("width",t.settings.width).attr("height",t.settings.height);if("undefined"!=typeof t.settings.chart.treeLayout)for(var m=0;m<t.settings.data.model.length;m++){var _=t.settings.data.strata[m],s=function(){return t.token.colorRange(m)};t.strata.create_pie_chart(t,_,y,_[0].value,s,(m+.5)*t.settings.chart.width/t.settings.data.model.length+t.settings.chart.x,t.settings.chart.y+t.settings.chart.height/6)}else{var _=t.settings.data.strata.map(function(t){return{value:t[0].value}}),s=t.token.colorRange;t.strata.create_pie_chart(t,_,y,t.settings.chart.radius,s,t.settings.chart.x+t.settings.chart.width/2,t.settings.chart.y+t.settings.chart.height/2)}}},create_pie_chart:function(t,a,e,s,n,r,i){{var g=t.settings.width/t.settings.data.model.length,o=t.settings.sedimentation.aggregation.height;d3.scale.linear().domain([0,t.settings.data.strata.length-1]).range([0,t.settings.width]),d3.scale.linear().domain([0,d3.max(a,function(t){return t.value})]).rangeRound([0,o]),t.settings.width,t.settings.height,t.settings.sedimentation.aggregation.height}labelr=s+30,donut=d3.layout.pie().sort(null),arc=d3.svg.arc().innerRadius(0).outerRadius(s);var l=Math.random();e.append("g.arcs_"+l).attr("class","arcs_"+l);{var d=e.selectAll(".arcs").data(donut(a.map(function(t){return t.value}))).enter().append("svg:g").attr("transform","translate("+r+","+i+")"),u=0;d3.svg.area().x(function(a){return t.settings.chart.spacer+a.x*(g-2*t.settings.chart.spacer)/smx}).y0(function(t){return o-t.y0*u}).y1(function(t){return o-(t.y+t.y0)*u}),d.append("path").attr("fill",function(t,a){return n(a)}).attr("d",function(t){return arc(t)}).each(function(t){this._current=t})}},update:function(t){if("undefined"!=typeof t.strata.stratas&&0!=t.strata.stratas.length){"function"==typeof settings.data.strata&&(t.strata.stratas=settings.data.strata());var a=(t.strata.stratas[0].length,20);smx=a-1,smy=0;var e=t.settings.chart.width/t.settings.data.model.length,s=t.settings.sedimentation.aggregation.height,n=(t.token.colorRange,d3.svg.area().x(function(a){return t.settings.chart.spacer+a.x*(e-2*t.settings.chart.spacer)/smx}).y0(function(t){return s-t.y0*t.offshit}).y1(function(t){return s-(t.y+t.y0)*t.offshit})),r=t.strata.stratas.map(function(a,e){for(var s=0,n=0;s<a.length;s++)n+=a[s].value(t,e);return n}),i=d3.scale.linear().domain([0,Math.max(d3.max(r),t.settings.sedimentation.aggregation.maxData)]).range([0,t.settings.sedimentation.aggregation.height]),g=d3.select("#"+t.settings.DOMelement.id),o=g.selectAll("g.gcol");t.settings.sedimentation.aggregation.invertStrata&&o.transition().duration(100).attr("transform",function(a,s){var n=t.settings.sedimentation.aggregation.height;return n=2*t.settings.sedimentation.aggregation.height-i(r[s]),"translate("+s*e+", "+(t.settings.chart.height-(2*t.settings.sedimentation.aggregation.height-i(r[s])))+")"});{o.selectAll("path").data(function(e,s){var n=d3.layout.stack().offset("expand")(t.strata.strata_layers(t,e.length,a,s));return smy=d3.max(n,function(t){return d3.max(t,function(t){return t.y0+t.y})}),n.map(function(t){t.map(function(t){return t.col=s,t})}),n})}if("StackedAreaChart"==t.settings.chart.type){g.selectAll("path").transition().duration(100).attr("d",function(a,e){return t.settings.sedimentation.aggregation.invertStrata?(t.chartUpdate(e,-2*s+t.settings.chart.height),hh=i(r[a[0].col])):(t.chartUpdate(e,-i(r[e])-(s-t.settings.chart.height)),hh=t.settings.chart.height-t.chart.getPosition(t)[a[0].col].y),a.map(function(t){return t.offshit=hh,t}),n(a)})}}}}}(jQuery);