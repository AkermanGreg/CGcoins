!function(t){t.fn.vs=function(){},t.fn._vs={},t.fn._vs.token={},t.fn._vs.draw={},t.fn._vs.stream={},t.fn._vs.chart={},t.fn._vs.phy={},t.fn._vs.decay={},t.fn._vs.flocculate={},t.fn._vs.strata={},t.fn._vs.aggregate={};var e=function(e,n){function s(t,e){var n={};for(var s in t)n[s]=t[s];for(var s in e)n[s]=e[s];return n}function i(t){if(null==t||"object"!=typeof t)return t;var e=t.constructor();for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);return e}this.token=t.fn._vs.token,this.draw=t.fn._vs.draw,this.stream=t.fn._vs.stream,this.chart=t.fn._vs.chart,this.phy=t.fn._vs.phy,this.decay=t.fn._vs.decay,this.flocculate=t.fn._vs.flocculate,this.strata=t.fn._vs.strata,this.requestAnimFrame,this.mouse={},this.mouse.x=0,this.mouse.y=0,this.mouse.isMouseDragging=!1,this.mouse.isMouseDown=!1,this.mouse.selectedBody=null,this.dataFlow=[],this.chartPhySetup={},this.tokens=[],this.world=null,this.ctx=null;var o,a=(t(e),this),r={x:0,y:0,width:290.5,height:300.5,DOMelement:null,chart:{x:void 0,y:void 0,width:void 0,height:void 0,colorRange:d3.scale.category10(),scale:d3.scale,type:"StackedAreaChart",spacer:5,column:3,wallColor:"rgba(230,230,230,0)",label:!0,radius:10},data:{model:[{label:"Column A"},{label:"Column B"},{label:"Column C"}],strata:[[{initValue:100,label:"Strata 1 col A"}],[{initValue:20,label:"Strata 1 col B"}],[{initValue:175,label:"Strata 2 col C"}]],token:[{timestamp:1,category:1,value:1,userdata:{},callback:{}}],tokenPast:0,stream:{provider:"generator",refresh:1250,now:0}},sedimentation:{token:{size:{original:4,minimum:2},visible:!0},incoming:{strategy:1,point:[{x:50,y:0},{x:100,y:0},{x:150,y:0}],target:[{x:50,y:0},{x:100,y:0},{x:150,y:0}]},granulate:{visible:!1},flocculate:{number:1,action:"buffer",strategy:"Size",bufferSize:5,bufferTime:1e3,bufferHeight:50,bufferFrameRate:25,buffer:[]},suspension:{height:null,incomming:"top",decay:{power:1.001},refresh:200},accumulation:{height:null},aggregation:{height:0,maxData:0,invertStrata:!1}},options:{refresh:40,panel:!1,scale:30,layout:!1,canvasFirst:!0}};this.now=function(){return(new Date).getTime()},this.globalDecay=function(t){return"undefined"==typeof t?this.settings.sedimentation.suspension.decay.power:this.settings.sedimentation.suspension.decay.power=t},this.getWorld=function(){return this.world},this.chartUpdate=function(t,e){var n={cat:t,y:e};this.chart[this.settings.chart.type](a,"update",n)},this.flocculateTokens=function(t){return this.flocculate.update(a,t)},this.flocculateAll=function(){return this.flocculate.all(a)},this.addToken=function(t){return this.token.addToken(a,t)},this.selectAll=function(t,e){return this.token.selectAll(a,t,e)},this.select=function(t,e){return this.token.select(a,t,e)},this.updateAll=function(){var t=this.chart.updateAll(a,key,value);return t},this.update=function(t,e){var n=this.chart.update(a,t,e);return n},s(r,n),void 0!=n.data&&(r.data=n.data),this.settings=t.extend(!0,r,n),this.settings.DOMelement=e,"undefined"==typeof this.settings.chart.width&&(this.settings.chart.width=this.settings.width),"undefined"==typeof this.settings.chart.x&&(this.settings.chart.x=0),"undefined"==typeof this.settings.chart.y&&(this.settings.chart.y=0),"undefined"==typeof this.settings.chart.height&&(this.settings.chart.height=this.settings.height),"undefined"==typeof this.settings.stream&&(this.settings.stream={}),"undefined"==typeof this.settings.stream.now&&(this.settings.stream.now=0),"undefined"==typeof this.settings.stream.provider&&(this.settings.stream.provider="generator"),"undefined"==typeof this.settings.stream.refresh&&(this.settings.stream.refresh=1e3),"undefined"==typeof this.settings.data.tokenPast&&(this.settings.data.tokenPast=0),"undefined"==typeof this.settings.data.tokens&&(this.settings.data.tokens=[]),"undefined"!=typeof this.settings.data.strata&&0!=this.settings.data.strata.length&&("undefined"==typeof this.settings.sedimentation.aggregation&&(this.settings.sedimentation.aggregation={}),"undefined"==typeof this.settings.sedimentation.aggregation.height&&(this.settings.sedimentation.aggregation.height=this.settings.chart.height/2),"undefined"==typeof this.settings.sedimentation.aggregation.maxData&&(this.settings.sedimentation.aggregation.maxData=10)),this.init=function(){function t(t,e,n){return e.mouse.selectedToken=t,t.GetBody().GetType()!=e.phy.b2Body.b2_staticBody&&t.GetShape().TestPoint(t.GetBody().GetTransform(),n)?(e.mouse.selectedToken=t,!1):!0}function n(t,e){var n=e.getBodyAtMouse(e);if(null!=n&&"undefined"!=typeof n.m_userData&&"undefined"!=typeof n.m_userData.callback){if("function"==typeof n.m_userData.callback.mouseover){var s=e.select("ID",n.m_userData.ID);n.m_userData.callback.mouseover(s)}if("function"==typeof n.m_userData.callback.mouseout){var i,s=e.select("ID",n.m_userData.ID),o=function(){var t=s,o=e,a=n;return function(){var e=o.getBodyAtMouse(o),n=!1;n=null!=e&&"undefined"!=typeof e.m_userData&&e.m_userData.ID==t.attr("ID")?!1:!0,n&&(a.m_userData.callback.mouseout(t),clearInterval(i))}};i=window.setInterval(o(),100)}}}function s(t,e){e.mouse.isMouseDown=!0,e.handleMouseMove(t,e);var n=e.getBodyAtMouse(e);if(null!=n&&"undefined"!=typeof n.m_userData&&"undefined"!=typeof n.m_userData.callback&&"function"==typeof n.m_userData.callback.onclick){var s=e.select("ID",n.m_userData.ID);n.m_userData.callback.onclick(s)}}function i(t,e){e.mouse.isMouseDown=!1}function r(t,e){e.mouse.isMouseDown?(e.mouse.isMouseDragging=!0,e.mouse.x=t.clientX,e.mouse.y=t.clientY):(e.handleMouseMove(t,e),n("move",e))}this.requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(t){window.setTimeout(t,1e3/60)}}(),this.world=new this.phy.b2World(new this.phy.b2Vec2(0,0),!0);var d=e.appendChild(document.createElement("div"));d.id="box_sediviz_"+h(),d.width=this.settings.width,d.height=this.settings.height,this.settings.DOMelement=d,o=d.appendChild(document.createElement("canvas")),o.id="canvas",o.width=this.settings.width,o.height=this.settings.height,o.style.position="absolute",this.ctx=o.getContext("2d"),this.chart[this.settings.chart.type](a,"init"),this.stream.init(a),this.flocculate.init(a),this.stream.update(a),this.token.init(a),this.strata.init(this),window.setInterval(function(){a.update(a)},a.settings.options.refresh/2),window.setInterval(function(){a.draw.update(a)},a.settings.options.refresh),window.setInterval(function(){a.decay.update(a)},a.settings.sedimentation.suspension.refresh),a.strata.update(a),this.getBodyAtMouse=function(e){var n=e.mouse.x/e.settings.options.scale,s=e.mouse.y/e.settings.options.scale,i=new e.phy.b2Vec2(n,s),o=new e.phy.b2AABB,a=.001;return o.lowerBound.Set(n-a,s-a),o.upperBound.Set(n+a,s+a),e.mouse.selectedToken=null,e.world.QueryAABB(function(n){return t(n,e,i)},o),e.mouse.selectedToken},this.handleMouseMove=function(t,e){canvasPosition=u(e.settings.DOMelement),e.mouse.x=t.clientX-(canvasPosition.offsetLeft-this.getScrollPosition()[0]),e.mouse.y=t.clientY-(canvasPosition.offsetTop-this.getScrollPosition()[1])},this.getScrollPosition=function(){return Array(document.documentElement&&document.documentElement.scrollLeft||window.pageXOffset||a.pageXOffset||document.body.scrollLeft,document.documentElement&&document.documentElement.scrollTop||window.pageYOffset||a.pageYOffset||document.body.scrollTop)},document.addEventListener("mousemove",function(t){r(t,a)}),document.addEventListener("mouseup",function(t){i(t,a)}),document.addEventListener("mousedown",function(t){s(t,a)})},this.mouse.update=function(){if(isMouseDown&&!mouseJoint){var t=getBodyAtMouse();if(t){var e=new b2MouseJointDef;e.bodyA=world.GetGroundBody(),e.bodyB=t,e.target.Set(mouseX,mouseY),e.collideConnected=!0,e.maxForce=300*t.GetMass(),mouseJoint=world.CreateJoint(e),t.SetAwake(!0)}}mouseJoint&&(isMouseDown?mouseJoint.SetTarget(new b2Vec2(mouseX,mouseY)):(world.DestroyJoint(mouseJoint),mouseJoint=null))},this.update=function(){this.world.Step(1/60,10,10),this.world.DrawDebugData(),this.world.ClearForces()};var u=function(t){for(var e=t.offsetTop,n=t.offsetLeft;t=t.offsetParent;)e+=t.offsetTop,n+=t.offsetLeft;return{offsetLeft:n,offsetTop:e}},h=function(){var t=function(){return Math.floor(65536*Math.random()).toString(16)};return t()+t()+"-"+t()+"-"+t()+"-"+t()+"-"+t()+t()+t()};this.utile={},this.utile.GUID=h,this.utile.clone=i,this.settings=t.extend(this.settings,{}||{}),this.init()};t.fn.vs=function(n){if(!arguments.length)var n={};return this.each(function(){var s=t(this);if(!s.data("VisualSedimentation")){var i=new e(this,n);s.data("visualSedimentation",i)}})}}(jQuery);